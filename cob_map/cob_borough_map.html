<!DOCTYPE html>
<html>
    <head>
        <!-- standard setup -->
        <meta charset='utf-8' />
        <title>Display a map</title>
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
        <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet' />
        <link href='cob_borough_map_styles.css' rel='stylesheet' />
    </head>

    <body>
        <div id='map'></div>
            <div class='map-overlay top'>
                <div class='map-overlay-inner'>
                    <!-- all the credits and data sources -->
                    <h2>Areas of Origin by London Borough 2004-2017</h2>
                    <p>Select a Borough to see the inflows from abroad, or select the total button in the top right to see all at once</p>
                    <p class="credit">Country of Origin Data: <a href="https://data.london.gov.uk/dataset/country-of-birth">London Datastore</a></p>
                    <h3>Year: <label id='active-year'>2004</label></h3>
                    <input id='slider' class='row' type='range' min='2004' max='2017' step='1' value='2004' />
                </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoibWtsb3Zza2kiLCJhIjoiY2l6N2R0azl2MDA1NDJ3cG9uZ2RoMzF5aiJ9.UacgAXrCVFX4BmcbH4oj_w';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mklovski/cjvb0602e09go1fn0zwgps0cn',
            // set the default load location
            center: [-0.012,51.493],
            zoom: 9.5
        });

        map.addControl(new mapboxgl.NavigationControl());

        map.on('load', function () {

            map.addLayer({
            id: 'borough_polygons',
            type: 'fill',
            source: {
             type: 'vector',
             url: 'mapbox://mklovski.90q77j05'
            },
            'source-layer': 'borough_polygons-7viimf',
            'layout': {
            'visibility': 'visible'
            },
            // style for the origin nodes, size according to people_count and then scale by 2000
            paint: {
            'fill-opacity': .85,
            'fill-color': '#ffffff'
            },
            });

            map.addLayer({
            id: 'borough_lines',
            type: 'line',
            source: {
             type: 'vector',
             url: 'mapbox://mklovski.64eprrsa'
            },
            'source-layer': 'borough_migration_lines-2i5nnu',
            'layout': {
            'visibility': 'visible'
            },
            // style for the origin nodes, size according to people_count and then scale by 2000
            paint: {
            'line-color': [
                'match',
                ['get', 'detailed_origin'],
                'European Union EU14', '#1b9e77',
                'European Union EU8', '#1b9e77',
                'European Union EU2', '#1b9e77',
                'European Union Other', '#1b9e77',
                'Other Europe', '#1b9e77',
                'North Africa', '#7570b3',
                'Sub-Saharan Africa', '#7570b3',
                'North America', '#99420c',
                'Central and South America', '#99420c',
                'Middle East and Central Asia', '#e55e5e',
                'South Asia', '#e55e5e',
                'East Asia', '#e55e5e',
                'South East Asia', '#e55e5e',
                'Oceania', '#3bb2d0',
                /* other */ '#ccc'
                ],
            'line-opacity': 1,
            'line-width': [
                '/',
                ['number', ['get', 'count']],
            2],
            },
            filter: ['==', ['number', ['get', 'year']], 2004]
            });

        // map.on('click', 'borough_polygons', function (e) {
        //     var name = e.features[0].properties.name;
        //     var borough_name = borough_lines.properties.borough_namename;
        //     if (name === 'borough_lines.borough_name') {
        //         map.setLayoutProperty(clickedLayer, 'visibility', 'none');
        //         map.setFilter('borough_lines', ['==', ['string', ['get', 'borough_name']], name]);
        //     } 
        //     else {}
        // });
 
        // var layers = document.getElementById('menu');
        // layers.appendChild(link);

        map.on('click', 'borough_lines', function (e) {
            var name = e.features[0].properties.borough_name;
            var detailed_origin = e.features[0].properties.detailed_origin
            var year = e.features[0].properties.year;
            var count = e.features[0].properties.count;
            var population = e.features[0].properties.population;
            // format the popup
            new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML("<h3>" + "In " + year + ", roughly " + (count*290) + " people migrated from " + detailed_origin + " to " + name + "</h3>")
            // " which is " + ((count/population)*100).toFixed(3) + "% of the population" + 
            .addTo(map);
        });
        // change the icon when you hover it
        map.on('mouseenter', 'borough_lines', function () {
            map.getCanvas().style.cursor = 'pointer';
        });
        // change it back when you leave
        map.on('mouseleave', 'borough_lines', function () {
            map.getCanvas().style.cursor = '';
        });

        document.getElementById('slider').addEventListener('input', function(e) {
        var year = parseInt(e.target.value);
        // update the map
        map.setFilter('borough_lines', ['==', ['number', ['get', 'year']], year]);
        // update text in the UI
        document.getElementById('active-year').innerText = year;
        });

    });
    </script>
</body>
</html>
